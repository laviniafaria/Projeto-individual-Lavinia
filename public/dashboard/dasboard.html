<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baralho Cigano | Dashboard</title>

    <script src="../js/sessao.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <!-- scripts do Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Barlow', Arial, sans-serif;
        }

        body {
            background-color: #472e51;
            color: white;
            display: flex;
            height: 100vh;
        }

        .janela {
            display: flex;
            width: 100%;
        }

        .header-left {
            width: 250px;
            background-color: #3a2442;
            padding: 20px;
            border-right: 2px solid gold;
            display: flex;
            flex-direction: column;
        }

        .header-left h1 {
            color: gold;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .hello {
            background-color: #5a3c65;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid gold;
        }

        .btn-nav, .btn-nav-white {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .btn-nav {
            background-color: gold;
            color: #472e51;
            font-weight: bold;
        }

        .btn-nav-white {
            background-color: #5a3c65;
            border: 1px solid gold;
        }

        .btn-nav-white a {
            color: white;
            text-decoration: none;
            display: block;
        }

        .btn-nav-white:hover {
            background-color: #6c4c7c;
        }

        .btn-logout {
            padding: 15px;
            margin-top: auto;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            background-color: #8b0000;
            border: 1px solid #ff0000;
        }

        .btn-logout:hover {
            background-color: #a52a2a;
        }

        .dash {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .btns-dash {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn-chart {
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid gold;
            background-color: #5a3c65;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-pink {
            background-color: gold;
            color: #472e51;
            font-weight: bold;
        }

        .btn-white {
            background-color: #5a3c65;
            color: white;
        }

        .display-none {
            display: none;
        }

        .display-block {
            display: block;
        }

        .tituloGraficos {
            color: gold;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
        }

        .graph {
            background-color: #5a3c65;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid gold;
            margin-bottom: 20px;
        }

        .label-captura {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        .cartas-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .carta-item {
            background-color: #5a3c65;
            border: 2px solid gold;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .carta-nome {
            color: gold;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .carta-significado {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="janela">
        <div class="header-left">
            <h1>Baralho Cigano</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav-white">
                <a href="./cartas.html">
                    <h3>Cartas</h3>
                </a>
            </div>

            <div class="btn-nav">
                <h3>Gráficos </h3>
            </div>

            <div class="btn-nav-white">
                <a href="./quiz.html">
                    <h3>Quiz</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

        <div class="dash">
            <div id="alerta"></div>

            <div class="btns-dash" id="btnCategoria">
                <!-- As categorias serão geradas dinamicamente -->
            </div>

            <div id="graficos">
                <!-- Os gráficos serão gerados dinamicamente -->
            </div>

            <div class="cartas-container" id="cartasRecentes">
                <!-- Cartas recentes serão exibidas aqui -->
            </div>
        </div>
    </div>
</body>

</html>

<script>
    // Simulando dados de sessão
    sessionStorage.NOME_USUARIO = "Lavinia";
    sessionStorage.CATEGORIAS = JSON.stringify([
        { id: 1, descricao: "Cartas de Amor" },
        { id: 2, descricao: "Cartas de Trabalho" },
        { id: 3, descricao: "Cartas de Família" }
    ]);

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;

    // Simulação de dados das cartas
    const cartasRecentes = [
        { id: 1, nome: "A Roda da Fortuna", significado: "Mudanças, sorte, ciclos" },
        { id: 2, nome: "O Cavaleiro", significado: "Notícias, mensagens, viagens" },
        { id: 3, nome: "Os Amantes", significado: "Escolhas, relacionamentos, união" },
        { id: 4, nome: "O Barco", significado: "Viagem, progresso, jornada" }
    ];

    window.onload = function() {
        exibirCategorias();
        exibirCartasRecentes();
    };

    function exibirCategorias() {
        var categorias = JSON.parse(sessionStorage.CATEGORIAS);
        categorias.forEach(item => {
            document.getElementById("btnCategoria").innerHTML += `
            <button class="btn-chart" onclick="exibirCategoria(${item.id})" id="btnCategoria${item.id}">${item.descricao}</button>
            `

            document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.id}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloCategoria${item.id}">${item.descricao}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.id}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.id}" style="color: white"></p>
                    </div>
                </div>
            `

            obterDadosGrafico(item.id)
        });

        if (categorias.length > 0) {
            exibirCategoria(categorias[0].id)
        }
    }

    function exibirCartasRecentes() {
        const container = document.getElementById("cartasRecentes");
        container.innerHTML = "<h3 style='color: gold; margin-bottom: 15px; width: 100%;'>Cartas Recentes</h3>";
        
        cartasRecentes.forEach(carta => {
            container.innerHTML += `
                <div class="carta-item">
                    <div class="carta-nome">${carta.nome}</div>
                    <div class="carta-significado">${carta.significado}</div>
                </div>
            `;
        });
    }

    function alterarTitulo(idCategoria) {
        var tituloCategoria = document.getElementById(`tituloCategoria${idCategoria}`)
        var descricao = JSON.parse(sessionStorage.CATEGORIAS).find(item => item.id == idCategoria).descricao;
        tituloCategoria.innerHTML = "Estatísticas de Consultas - <span style='color: gold'>" + descricao + "</span>"
    }

    function exibirCategoria(idCategoria) {
        let todasAsCategorias = JSON.parse(sessionStorage.CATEGORIAS);

        for (i = 0; i < todasAsCategorias.length; i++) {
            // exibindo - ou não - o gráfico
            if (todasAsCategorias[i].id != idCategoria) {
                let elementoAtual = document.getElementById(`grafico${todasAsCategorias[i].id}`)
                if (elementoAtual.classList.contains("display-block")) {
                    elementoAtual.classList.remove("display-block")
                }
                elementoAtual.classList.add("display-none")

                // alterando estilo do botão
                let btnAtual = document.getElementById(`btnCategoria${todasAsCategorias[i].id}`)
                if (btnAtual.classList.contains("btn-pink")) {
                    btnAtual.classList.remove("btn-pink")
                }
                btnAtual.classList.add("btn-white")
            }
        }

        // exibindo - ou não - o gráfico
        let graficoExibir = document.getElementById(`grafico${idCategoria}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")

        // alterando estilo do botão
        let btnExibir = document.getElementById(`btnCategoria${idCategoria}`)
        btnExibir.classList.remove("btn-white")
        btnExibir.classList.add("btn-pink")
    }

    function obterDadosGrafico(idCategoria) {
        alterarTitulo(idCategoria)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        // Simulação de dados para o gráfico
        const dadosSimulados = [
            { momento_grafico: "Jan", consultas: Math.floor(Math.random() * 50) + 10, acertos: Math.floor(Math.random() * 40) + 5 },
            { momento_grafico: "Fev", consultas: Math.floor(Math.random() * 50) + 10, acertos: Math.floor(Math.random() * 40) + 5 },
            { momento_grafico: "Mar", consultas: Math.floor(Math.random() * 50) + 10, acertos: Math.floor(Math.random() * 40) + 5 },
            { momento_grafico: "Abr", consultas: Math.floor(Math.random() * 50) + 10, acertos: Math.floor(Math.random() * 40) + 5 },
            { momento_grafico: "Mai", consultas: Math.floor(Math.random() * 50) + 10, acertos: Math.floor(Math.random() * 40) + 5 },
            { momento_grafico: "Jun", consultas: Math.floor(Math.random() * 50) + 10, acertos: Math.floor(Math.random() * 40) + 5 }
        ];

        plotarGrafico(dadosSimulados, idCategoria);
    }

    function plotarGrafico(resposta, idCategoria) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Consultas Realizadas',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            },
            {
                label: 'Acertos em Quiz',
                data: [],
                fill: false,
                borderColor: 'rgb(255, 215, 0)',
                backgroundColor: 'rgba(255, 215, 0, 0.2)',
                tension: 0.1
            }]
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.consultas);
            dados.datasets[1].data.push(registro.acertos);
        }

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Desempenho nas Cartas'
                    }
                }
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idCategoria}`),
            config
        );

        setTimeout(() => atualizarGrafico(idCategoria, dados, myChart), 5000);
    }

    function atualizarGrafico(idCategoria, dados, myChart) {
        // Simulação de novo registro
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const novoRegistro = {
            momento_grafico: meses[Math.floor(Math.random() * meses.length)],
            consultas: Math.floor(Math.random() * 50) + 10,
            acertos: Math.floor(Math.random() * 40) + 5
        };

        console.log(`Novo dado simulado: ${JSON.stringify(novoRegistro)}`);

        let avisoCaptura = document.getElementById(`avisoCaptura${idCategoria}`)
        avisoCaptura.innerHTML = ""

        // Atualizando dados do gráfico
        dados.labels.shift();
        dados.labels.push(novoRegistro.momento_grafico);

        dados.datasets[0].data.shift();
        dados.datasets[0].data.push(novoRegistro.consultas);

        dados.datasets[1].data.shift();
        dados.datasets[1].data.push(novoRegistro.acertos);

        myChart.update();

        avisoCaptura.innerHTML = "<i class='fa-solid fa-circle-info'></i> Gráfico atualizado com os dados mais recentes."

        // Atualiza a cada 5 segundos
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idCategoria, dados, myChart), 5000);
    }

    function limparSessao() {
        sessionStorage.clear();
        alert("Sessão encerrada. Redirecionando para a página inicial...");
        window.location.href = "index.html";
    }
</script>